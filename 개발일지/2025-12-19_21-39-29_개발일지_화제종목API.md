```markdown
# 개발일지 - 화제 종목 조회 Fast API 구현

## 작성시각
2025년 12월 19일 21:39:29

## 해결하고자 한 문제

이전에 구현한 TrendingStockService와 NewsService를 활용하여 프론트엔드에서 사용할 수 있는 REST API를 구현해야 했습니다.

**핵심 요구사항:**
1. GET /api/stocks/trending - 화제 종목 조회 (스크리너 타입별)
2. GET /api/stocks/{ticker} - 종목 상세 정보 조회
3. Pydantic 모델로 응답 정의
4. HTTPException을 사용한 에러 처리
5. CORS 설정 (프론트엔드 연동)

## 해결된 것

### 1. Pydantic 모델 정의

**파일 위치:** `backend/models/stock_models.py`

**주요 모델:**

1. **ScreenerType (Enum)**
   - most_actives, day_gainers, day_losers

2. **NewsItem**
   - title, url, published_date, author

3. **StockBasicInfo**
   - symbol, shortName, longName
   - regularMarketPrice, regularMarketChange, regularMarketChangePercent
   - regularMarketVolume, marketCap

4. **StockDetailInfo**
   - price, summary_detail, financial_data

5. **NewsSearchResult**
   - ticker, query, total_results, news, search_period

6. **TrendingStockResponse**
   - 화제 종목 조회 API 응답 모델
   - symbol, screener_type, basic_info, detail_info, news

7. **StockInfoResponse**
   - 종목 상세 정보 API 응답 모델
   - symbol, basic_info, detail_info, news

8. **ErrorResponse**
   - detail, error_code

### 2. FastAPI 애플리케이션 구현

**파일 위치:** `backend/main.py`

**구현된 엔드포인트:**

#### 1. GET / (루트)
```python
{
    "message": "굿모닝 월가 API",
    "version": "1.0.0",
    "docs": "/api/docs"
}
```

#### 2. GET /api/health (헬스 체크)
```python
{
    "status": "healthy",
    "services": {
        "trending_stock": "available",
        "news": "available" or "unavailable (API key required)"
    }
}
```

#### 3. GET /api/stocks/trending (화제 종목 조회)
**Query Parameters:**
- `type`: ScreenerType (most_actives, day_gainers, day_losers)
- `include_news`: bool (기본값: true)
- `news_count`: int (1-20, 기본값: 5)
- `news_hours`: int (1-168, 기본값: 24)

**응답:**
```json
{
    "symbol": "BBAI",
    "screener_type": "most_actives",
    "basic_info": {
        "symbol": "BBAI",
        "longName": "BigBear.ai Holdings, Inc.",
        "regularMarketPrice": 5.63,
        "regularMarketChangePercent": 3.49,
        ...
    },
    "detail_info": {
        "price": {...},
        "summary_detail": {...},
        "financial_data": {...}
    },
    "news": {
        "total_results": 5,
        "news": [...]
    }
}
```

#### 4. GET /api/stocks/{ticker} (종목 상세 정보)
**Path Parameter:**
- `ticker`: 종목 심볼 (대문자, 1-10자, 정규식: ^[A-Z]+$)

**Query Parameters:**
- `include_news`: bool (기본값: true)
- `news_count`: int (1-20, 기본값: 10)
- `news_hours`: int (1-168, 기본값: 48)

**응답:**
```json
{
    "symbol": "AAPL",
    "basic_info": {...},
    "detail_info": {...},
    "news": {...}
}
```

#### 5. GET /api/stocks/trending/all (모든 스크리너 조회)
**Query Parameters:**
- `include_news`: bool (기본값: false)

**응답:**
```json
{
    "most_actives": {...},
    "day_gainers": {...},
    "day_losers": {...}
}
```

### 3. CORS 설정

프론트엔드(Next.js) 연동을 위한 CORS 설정:

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:3000",  # Next.js 개발 서버
        "http://localhost:3001",
        "http://127.0.0.1:3000",
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 4. 에러 처리

**HTTPException 사용:**
- 400: 잘못된 요청 (스크리너 타입 오류 등)
- 404: 종목을 찾을 수 없음
- 500: 서버 오류

**예시:**
```python
if "error" in result:
    raise HTTPException(
        status_code=400,
        detail=result["error"]
    )

if not symbol:
    raise HTTPException(
        status_code=404,
        detail="종목을 찾을 수 없습니다."
    )
```

### 5. NewsService 통합

뉴스 검색은 선택적 기능으로 구현:
- `include_news=true`일 때만 뉴스 검색 수행
- EXA_API_KEY가 없어도 기본 기능은 정상 작동
- 뉴스 조회 실패 시에도 전체 요청은 성공

```python
def get_news_service() -> Optional[NewsService]:
    """NewsService 인스턴스 반환 (API 키가 있을 때만)"""
    try:
        return NewsService()
    except (ImportError, ValueError) as e:
        logger.warning(f"NewsService를 초기화할 수 없습니다: {e}")
        return None
```

### 6. API 문서 자동 생성

FastAPI의 자동 문서 생성 기능:
- **Swagger UI**: http://localhost:8000/api/docs
- **ReDoc**: http://localhost:8000/api/redoc

문서에는 다음이 포함됨:
- 각 엔드포인트의 설명
- 파라미터 정의 및 검증 규칙
- 응답 모델 및 예시
- 에러 응답 정의

### 7. 테스트 결과

**TestClient를 사용한 테스트 (simple_api_test.py):**
```
총 테스트: 5개
성공: 5개
실패: 0개

>>> 모든 테스트를 통과했습니다!

테스트 항목:
- 루트 엔드포인트 [PASS]
- 헬스 체크 [PASS]
- 화제 종목 조회 [PASS]
- 종목 상세 정보 [PASS]
- 모든 스크리너 조회 [PASS]
```

**실제 조회 결과:**
- most_actives: BBAI (BigBear.ai Holdings) - +3.49%
- day_gainers: DJTWW (Trump Media) - 대폭 상승
- day_losers: INSP (Inspire Medical Systems) - 하락
- AAPL: $272.19

## 해결되지 않은 것

없음 - 모든 요구사항이 성공적으로 구현되고 테스트를 통과했습니다.

**참고:**
- uvicorn을 직접 실행하는 방식은 일부 환경에서 404 에러가 발생할 수 있음
- TestClient를 사용한 테스트는 모든 환경에서 정상 작동

## 향후 개발을 위한 컨텍스트

### 1. 파일 구조

```
backend/
├── models/
│   ├── __init__.py                    # 모델 패키지
│   └── stock_models.py                # Pydantic 모델 정의
├── services/
│   ├── __init__.py
│   ├── trending_stock_service.py      # 화제 종목 서비스
│   └── news_service.py                # 뉴스 서비스
├── main.py                            # FastAPI 애플리케이션
├── simple_api_test.py                 # TestClient 테스트
├── test_api.py                        # HTTP 요청 테스트
└── .env.example                       # 환경 변수 예제
```

### 2. API 서버 실행 방법

**방법 1: main.py 직접 실행**
```bash
cd backend
python main.py
```

**방법 2: uvicorn 사용**
```bash
cd backend
python -m uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

**방법 3: 프로덕션 (gunicorn + uvicorn)**
```bash
gunicorn main:app --workers 4 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

### 3. 프론트엔드 연동

**fetch 예시:**
```javascript
// 화제 종목 조회
const response = await fetch(
    'http://localhost:8000/api/stocks/trending?type=most_actives&include_news=true'
);
const data = await response.json();

console.log(data.symbol); // "BBAI"
console.log(data.basic_info.regularMarketPrice); // 5.63
console.log(data.news.total_results); // 5
```

**axios 예시:**
```javascript
import axios from 'axios';

const api = axios.create({
    baseURL: 'http://localhost:8000/api',
});

// 종목 상세 정보
const { data } = await api.get('/stocks/AAPL', {
    params: {
        include_news: true,
        news_count: 10
    }
});
```

### 4. 환경 변수 설정

**.env 파일:**
```env
# Exa API (뉴스 검색 - 선택)
EXA_API_KEY=your_exa_api_key

# CORS 허용 도메인 (프로덕션)
CORS_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
```

### 5. Pydantic 모델 활용

**타입 안전성:**
```python
# FastAPI가 자동으로 검증
@app.get("/api/stocks/trending")
async def get_trending_stock(
    type: ScreenerType = Query(ScreenerType.MOST_ACTIVES),
    # type이 Enum이므로 잘못된 값 자동 거부
):
    ...
```

**응답 모델 검증:**
```python
@app.get("/api/stocks/trending", response_model=TrendingStockResponse)
async def get_trending_stock(...):
    # 반환값이 TrendingStockResponse 형식에 맞지 않으면 에러
    return response
```

### 6. API 문서 커스터마이징

**엔드포인트 설명 추가:**
```python
@app.get(
    "/api/stocks/trending",
    response_model=TrendingStockResponse,
    summary="화제 종목 조회",
    description="스크리너 타입별 화제 종목 TOP 1을 조회합니다.",
    responses={
        200: {"description": "화제 종목 조회 성공"},
        400: {"model": ErrorResponse, "description": "잘못된 요청"},
    }
)
```

### 7. 로깅

**로그 레벨:**
- INFO: 정상적인 API 요청/응답
- WARNING: NewsService 초기화 실패 등
- ERROR: 예외 발생

**로그 예시:**
```
INFO:main:화제 종목 조회 요청 - 타입: most_actives
INFO:services.trending_stock_service:화제 종목 조회 시작 - 스크리너: most_actives, 개수: 1
INFO:services.trending_stock_service:TOP 1 종목 선정: BBAI
INFO:main:화제 종목 조회 완료 - 종목: BBAI
```

### 8. 성능 최적화

**고려사항:**
1. **캐싱**: Redis를 사용한 응답 캐싱
   ```python
   from fastapi_cache import FastAPICache
   from fastapi_cache.backends.redis import RedisBackend
   ```

2. **비동기 처리**: 뉴스 조회를 백그라운드 태스크로
   ```python
   from fastapi import BackgroundTasks
   ```

3. **Rate Limiting**: slowapi를 사용한 요청 제한
   ```python
   from slowapi import Limiter
   ```

### 9. 보안

**주요 보안 기능:**
1. **입력 검증**: Pydantic을 통한 자동 검증
2. **Path Parameter 검증**: 정규식 사용 (^[A-Z]+$)
3. **Query Parameter 검증**: 범위 제한 (ge=1, le=20)
4. **CORS**: 허용된 도메인만 접근 가능

**추가 보안 권장사항:**
- HTTPS 사용 (프로덕션)
- API 키 인증 (선택)
- Rate Limiting
- 요청 크기 제한

### 10. 테스트

**TestClient 사용 (권장):**
```python
from fastapi.testclient import TestClient
from main import app

client = TestClient(app)

def test_trending_stock():
    response = client.get("/api/stocks/trending?type=most_actives")
    assert response.status_code == 200
    data = response.json()
    assert "symbol" in data
```

**pytest 통합:**
```bash
pip install pytest pytest-asyncio
pytest backend/simple_api_test.py -v
```

### 11. 배포

**Docker 컨테이너화 (예정):**
```dockerfile
FROM python:3.12-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**docker-compose:**
```yaml
version: '3.8'
services:
  api:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - EXA_API_KEY=${EXA_API_KEY}
```

### 12. 모니터링 및 로깅 (향후)

**Prometheus + Grafana:**
- API 응답 시간 모니터링
- 요청 성공/실패 비율
- 서비스별 호출 횟수

**Sentry:**
- 에러 추적 및 알림
- 성능 모니터링

### 13. API 버전 관리

**향후 버전 추가:**
```python
# v1
from routers import v1_router
app.include_router(v1_router, prefix="/api/v1")

# v2 (향후)
from routers import v2_router
app.include_router(v2_router, prefix="/api/v2")
```

### 14. 프론트엔드 TypeScript 타입 생성

**openapi-typescript 사용:**
```bash
npx openapi-typescript http://localhost:8000/openapi.json --output types/api.ts
```

생성된 TypeScript 타입:
```typescript
export interface TrendingStockResponse {
    symbol?: string;
    screener_type: string;
    basic_info?: StockBasicInfo;
    detail_info?: StockDetailInfo;
    news?: NewsSearchResult;
}
```

## 작업 소요 시간

약 50분 (모델 정의 15분, API 구현 25분, 테스트 10분)

## 추가 노트

- FastAPI의 자동 문서 생성 기능이 매우 유용함
- Pydantic 모델을 사용하면 타입 안전성과 검증이 자동으로 처리됨
- TestClient를 사용한 테스트가 uvicorn 서버 실행보다 안정적
- CORS 설정은 프로덕션 배포 시 도메인을 정확히 설정해야 함
- 뉴스 검색은 선택적 기능으로 구현하여 EXA_API_KEY 없이도 기본 기능 사용 가능
```
